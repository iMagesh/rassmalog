<%
=begin
  This is a template for generating a complete HTML web page.

  The following variables are available for use in this template:
  * BLOG        - data from the blog configuration file
  * LANG        - data from the translation file
  * ENTRIES     - array of all blog entries (Entry objects)
  * NEW_ENTRIES - array of recent blog entries (Entry objects)
  * TAGS        - array of all tags (Section objects)
  * ARCHIVES    - array of all archives (Section objects)
  * FEEDS       - array of all feeds (Feed objects)
  * @target     - object for which we are generating HTML
  * @title      - title for the HTML page we are generating
  * @content    - body for the HTML page we are generating

  NOTE that the "display: none" stuff in this template is meant to improve
  the readability and usability of this web page in text-only web browsers.
=end

  name_html   = BLOG.name.to_html
  info_html   = BLOG.info.to_html
  author_html = BLOG.author.to_html
%>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=<%= BLOG.encoding %>" />
    <meta http-equiv="content-language" content="<%= BLOG.language %>" />
    <meta name="description" content="<%= h(
      if @target.is_a? Entry and summary = @target.summary
        summary
      else
        info_html
      end
    ) %>" />
    <% if @target.is_a? Entry and not @target.tags.empty? %>
    <meta name="keywords" content="<%= @target.tags.map {|t| t.name}.join(', ') %>" />
    <% end %>
    <meta name="date" content="<%= Time.now.rfc822 %>" />
    <meta name="author" content="<%=h author_html %>" />
    <meta name="generator" content="<%= Rassmalog %>" />

    <% FEEDS.each do |feed| %>
    <link rel="alternate" type="application/rss+xml" href="<%= feed.file %>" title="<%= feed.name %>" />
    <% end %>

    <link rel="stylesheet" type="text/css" href="styles/screen.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="styles/print.css" media="print" />
    <link rel="alternate stylesheet" type="text/css" href="styles/print.css" title="Print Preview" />

    <title><%= @title.to_html %> &mdash; <%= name_html %></title>
  </head>
  <body>
    <p style="display: none">
      <a href="#content">Skip to main content</a>
      <br/>
      <a href="#links">Skip to navigation menu</a>
    </p>

    <div id="header">
      <h1 class="name"><%= link('index.html', name_html) %></h1>
      <div class="info"><%= info_html %></div>
    </div>

    <br style="display: none"/>
    <hr style="display: none"/>

    <div id="content"><%= @content %></div>

    <% if @content !~ %r{<hr.*?>(</.*?>|<[^/].*?/>|.)*\z}m %>
    <br style="display: none"/>
    <hr style="display: none"/>
    <% end %>

    <%
      # highlights the given item if it corresponds to the current web page
      def menu_item aItem
        if (@target.object_id == aItem.object_id) or
           (@target.is_a? Entry and aItem == ENTRIES) or
           (@target.is_a? Section and aItem == @target.parent)
        then
          %{<strong class="current">#{aItem.to_link}</strong>}
        else
          aItem.to_link
        end
      end
    %>

    <ul id="links">
      <li>
        <%= LANG['Navigation'] %>
        <ul>
          <li><%= menu_item(NEW_ENTRIES) %></li>
          <li><%= menu_item(ENTRIES) %></li>
          <li><%= menu_item(TAGS) %></li>
          <li><%= menu_item(ARCHIVES) %></li>
          <li>
            <%= LANG['Subscribe'] %> <img src="images/feed-icon-14x14.png" alt="RSS feed" title="RSS feed" />
            <ul>
              <% FEEDS.each do |feed| %>
              <li><a type="application/rss+xml" href="<%= feed.file %>"><%= feed.name.to_s.to_html %></a></li>
              <% end %>
            </ul>
          </li>
          <li>
            <%= LANG['Search'] %>
            <form id="search" method="get" <%=
              if @title == LANG['Search']
                # avoid having to reload the entire search page (which can
                # get very large in file size) each time the user submits
                # the search form when the user is already on the search page
                %{action="#" onsubmit="search_handler(); return false;"}
              else
                %{action="#{LANG['Search'].to_file_name}.html"}
              end
            %>>
              <input type="text" name="q" id="search-query"/>
              <input type="submit" value="&crarr;"/>
            </form>
          </li>
        </ul>
      </li>
      <%= BLOG.links.to_html if BLOG.links %>
    </ul>

    <p id="footer">
      Authored by <%=
        if BLOG.email
          link BLOG.email.to_url, author_html
        else
          author_html
        end
      %>.
      <br/>
      Generated by <%= Rassmalog.to_link %>.
    </p>
  </body>
</html>
